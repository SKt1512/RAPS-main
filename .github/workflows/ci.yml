name: RAPS CI Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout repository
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Setup Python
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # --------------------------------------------------
      # Install system dependencies (OpenCV, Shapely)
      # --------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1 \
            libglib2.0-0 \
            libspatialindex-dev

      # --------------------------------------------------
      # Upgrade pip
      # --------------------------------------------------
      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # --------------------------------------------------
      # Install Python dependencies
      # --------------------------------------------------
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # --------------------------------------------------
      # Sanity import checks (core system)
      # --------------------------------------------------
      - name: Core import checks
        run: |
          python - <<EOF
          from core.orchestrator import AdaptiveOrchestrator
          from core.routing_engine import RoutingEngine
          from services.vision_service import get_obstacle_factor_from_video
          from services.text_service import get_incident_factor
          print("Core imports OK")
          EOF

      # --------------------------------------------------
      # Routing engine graph load check
      # --------------------------------------------------
      - name: Routing engine graph load
        run: |
          python - <<EOF
          from core.routing_engine import RoutingEngine
          engine = RoutingEngine()
          assert engine.graph is not None
          print("Graph loaded successfully")
          EOF

      # --------------------------------------------------
      # NLP fallback check (no hard failure allowed)
      # --------------------------------------------------
      - name: NLP service fallback check
        run: |
          python - <<EOF
          from services.text_service import get_incident_factor
          factor = get_incident_factor()
          assert 0.0 <= factor <= 1.0
          print("NLP fallback OK")
          EOF

      # --------------------------------------------------
      # Vision service fallback check (no video inference)
      # --------------------------------------------------
      - name: Vision service availability check
        run: |
          python - <<EOF
          from services.vision_service import _load_model
          model = _load_model()
          print("Vision service initialized (model may be None in CI)")
          EOF

      # --------------------------------------------------
      # Orchestrator dry run (no video)
      # --------------------------------------------------
      - name: Orchestrator dry run
        run: |
          python - <<EOF
          from core.orchestrator import AdaptiveOrchestrator
          orchestrator = AdaptiveOrchestrator()
          route = orchestrator.compute_adaptive_route(
              start_coords=(37.7749, -122.4194),
              end_coords=(37.7879, -122.4074),
              video_file=None
          )
          assert route is None or isinstance(route, list)
          print("Orchestrator dry run OK")
          EOF
